# NOTIFY-SERVICE

**NOTIFY-SERVICE** является сервисом рассылки уведомлений для [golos.io](https://golos.io) и приложений.
Сервис извлекает из блокчейна необходимые данные, определяет произошедшие события и группирует их,
сохраняя в базе данных.
Историю можно выгрузить по запросу, указав тип интересуемого события.
Если пользователь онлайн - он получает уведомления в реальном времени.
Данные хранятся ограниченное время, после чего удаляются из базы данных.
При ошибке отправки нотификации пользователю - происходит автоматическая отписка онлайн рассылки
для конкретного устройства.
Пользователь может получать уведомления сразу на несколько устройств.
Все параметры можно настроить.

API JSON-RPC:  
*Предполагается что запросы поступают из фронтенд-гейта, либо в совместимом формате.*

 ```
 subscribe:   // подписка на рассылку нотификаций
     <null>   // без параметров
    
 unsubscribe: // отписка от рассылок нотификаций
     <null>   // без параметров
     
 history:                            // Получение истории пользователя
     skip: <number>(0) [0..Infinity] // Количество событий, которые необходимо пропустить
     limit: <number>(10) [1..100]    // Количество событий, которое нужно получить
     type: <eventType>               // Один из типов событий           
          [
            vote               // лайк (голос)
          | flag               // флаг (дизлайк, жалоба)
          | transfer           // перевод средств
          | reply              // ответ на пост или комментарий
          | subscribe          // подписка на блог
          | unsubscribe        // отписка от блога
          | mention            // упоминание в посте, заголовке поста или в комменте (через @)
          | repost             // репост
          | award              // награда пользователю (не реализованно в данной версии)
          | curatorAward       // награда куратору     (не реализованно в данной версии)
          | message            // личное сообщение     (не реализованно в данной версии)
          | witnessVote        // голос за делегата
          | witnessCancelVote  // отмена голоса за делегата
          ]       
           
 ```

Возможные переменные окружения `ENV`:
  
  - `GLS_FRONTEND_GATE_CONNECT` *(обязательно)* - адрес подключения к микросервису фронтенд-гейта.
    
  - `EVENT_EXPIRATION` - время в миллисекундах, после которого эвент будет удален из истории.  
   Дефолтное значение - `1000 * 60 * 60 * 24 * 30` (1 месяц) 
  
  - `GLS_GATE_HOST` *(обязательно)* - адрес, который будет использован для входящих подключений связи микросервисов.
   Дефолтное значение при запуске без докера - `127.0.0.1`
  
  - `GLS_GATE_PORT` *(обязательно)* - адрес порта, который будет использован для входящих подключений связи микросервисов.
   Дефолтное значение при запуске без докера - `8080`
  
  - `GLS_METRICS_HOST` *(обязательно)* - адрес хоста для метрик StatsD.
   Дефолтное значение при запуске без докера - `127.0.0.1`
        
  - `GLS_METRICS_PORT` *(обязательно)* - адрес порта для метрик StatsD.
   Дефолтное значение при запуске без докера - `8125`
  
  - `GLS_MONGO_CONNECT` - строка подключения к базе MongoDB.  
   Дефолтное значение - `mongodb://mongo/admin`
  
  - `GLS_DAY_START` - время начала нового дня в часах относительно UTC, используется для таких вещей как валидация "1 пост в сутки".    
   Дефолтное значение - `3` (день начинается в 00:00 по Москве). 
  
  - `GLS_BLOCKCHAIN_SUBSCRIBE_TIMEOUT` - таймаут подписки на новые блоки, срабатывает если за это время от блокчейн-ноды не пришло ни единого блока.  
   Дефолтное значение - `60000`, что равно одной минуте.
       
  - `GLS_BLOCKCHAIN_CONNECT` - адрес блокчейн-ноды для прослушивания.  
   Дефолтное значение - `wss://ws.golos.io`
 
Для запуска сервиса достаточно вызвать команду `docker-compose up` в корне проекта, предварительно указав
необходимые `ENV` переменные. 
