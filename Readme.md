# NOTIFY-SERVICE

**NOTIFY-SERVICE** является сервисом рассылки уведомлений для [golos.io](https://golos.io) и приложений.
Сервис извлекает из блокчейна необходимые данные, определяет произошедшие события и группирует их,
сохраняя в базе данных.
Историю можно выгрузить по запросу, указав тип интересуемого события.
Если пользователь онлайн - он получает уведомления в реальном времени через связанный сервис ONLINE-NOTIFY-SERVICE.
Также происходят уведомления через push для пользователей мобильных устройств и web-push для браузеров, используется PUSH-SERVICE.
Данные хранятся ограниченное время, после чего удаляются из базы данных.

API JSON-RPC:

 ```
 history:                                      // Получение истории пользователя
     fromId: <number>(null)                    // ID последнего события после которого формировать выдачу, если нужно
     limit: <number>(10) [1..100]              // Количество событий, которое нужно получить
     types: <'all'|[string(eventType)]>('all') // Массив типов необходимых событий или строка 'all' для всех сразу
          [
            vote               // лайк (голос)
          | flag               // флаг (дизлайк, жалоба)
          | transfer           // перевод средств
          | reply              // ответ на пост или комментарий
          | subscribe          // подписка на блог
          | unsubscribe        // отписка от блога
          | mention            // упоминание в посте, заголовке поста или в комменте (через @)
          | repost             // репост
          | award              // награда пользователю (не реализованно в данной версии)
          | curatorReward       // награда куратору     (не реализованно в данной версии)
          | message            // личное сообщение     (не реализованно в данной версии)
          | witnessVote        // голос за делегата
          | witnessCancelVote  // отмена голоса за делегата
          ]       
           
 ```

Формат данных истории:

 ```
 // Общий вид ответа

 total <number>    // Общее число эвентов в хранимой истории (история затирается со временем)
 fresh <number>    // Общее число эвентов, которые ещё не были просмотренны
 data: <[object]>  // Данные эвентов в виде массива объектов

 // Общий вид данных эвента

 eventType <string>  // Тип эвента
 fresh <boolean>     // Пометка того является ли эвент не просмотренным
 counter <number>    // Значение группировки, указывает на сквошинг эвентов в один эвент
 (concrete data)     // Данные, относящиеся к конкретному эвенту (смотри ниже)

 // Формат каждого конкретного типа эвента

 vote:                        // лайк (голос)
     permlink <string>        // ссылка на целевой пост/комментарий
     fromUsers <[string]>     // юзеры-источники эвента

 flag:                        // флаг (дизлайк, жалоба)
     permlink <string>        // ссылка на целевой пост/комментарий
     fromUsers <[string]>     // юзеры-источники эвента

 transfer:                    // перевод средств
     fromUsers <[string]>     // юзеры-источники эвента
     amount <string>          // количество и тип токенов через пробел

 reply:                       // ответ на пост или комментарий
     permlink <string>        // ссылка на целевой пост/комментарий
     parentPermlink <string>  // родительский пост/комментарий целевого поста/комментария
     fromUsers <[string]>     // юзеры-источники эвента

 subscribe:                   // подписка на блог
     fromUsers <[string]>     // юзеры-источники эвента

 unsubscribe:                 // отписка от блога
     fromUsers <[string]>     // юзеры-источники эвента

 mention:                     // упоминание в посте, заголовке поста или в комменте (через @)
     permlink <string>        // ссылка на целевой пост/комментарий
     parentPermlink <string>  // родительский пост целевого поста/комментария
     fromUsers <[string]>     // юзеры-источники эвента

 repost:                      // репост
     permlink <string>        // ссылка на целевой пост
     fromUsers <[string]>     // юзеры-источники эвента

 award:                       // награда пользователю
     permlink <string>        // ссылка на целевой пост
     award:                   // награда
         golos <number>       // в голосах
         golosPower <number>  // в силе голоса
         gbg <number>         // в голос/золоте

 curatorReward:                // награда куратору
     permlink <string>        // ссылка на целевой пост
     award:                   // награда
         golos <number>       // в голосах
         golosPower <number>  // в силе голоса
         gbg <number>         // в голос/золоте

 message:                     // личное сообщение
     fromUsers <[string]>     // юзеры-источники эвента
                    
 witnessVote:                 // голос за делегата
     fromUsers <[string]>     // юзеры-источники эвента

 witnessCancelVote:           // отмена голоса за делегата
     fromUsers <[string]>     // юзеры-источники эвента
 ```

Формат данных рассылаемых эвентов:

 ```
 vote:
     user <string>      // Пользователь, котрому предназначается эвент
     counter <number>   // Количество эвентов данного типа, склеенных воедино
     voter <string>     // Пользователь-инициатор
     permlink <string>  // Целевой пост/комментарий

 flag:
     user <string>      // Пользователь, котрому предназначается эвент
     counter <number>   // Количество эвентов данного типа, склеенных воедино
     voter <string>     // Пользователь-инициатор
     permlink <string>  // Целевой пост/комментарий

 transfer:
     user <string>     // Пользователь, котрому предназначается эвент
     counter <number>  // Количество эвентов данного типа, склеенных воедино
     from <string>     // Пользователь-инициатор
     amount <string>   // Количество в виде строки-числа и типа валюты через пробел

 reply:
     user <string>      // Пользователь, котрому предназначается эвент
     counter <number>   // Количество эвентов данного типа, склеенных воедино
     author <string>    // Пользователь-инициатор
     permlink <string>  // Целевой пост/комментарий

 subscribe:
     user <string>      // Пользователь, котрому предназначается эвент
     counter <number>   // Количество эвентов данного типа, склеенных воедино
     follower <string>  // Пользователь-инициатор

 unsubscribe:
     user <string>      // Пользователь, котрому предназначается эвент
     counter <number>   // Количество эвентов данного типа, склеенных воедино
     follower <string>  // Пользователь-инициатор

 mention:
     user <string>      // Пользователь, котрому предназначается эвент
     counter <number>   // Количество эвентов данного типа, склеенных воедино
     author <string>    // Пользователь-инициатор
     permlink <string>  // Целевой пост/комментарий

 repost:
     user <string>      // Пользователь, котрому предназначается эвент
     counter <number>   // Количество эвентов данного типа, склеенных воедино
     reposter <string>  // Пользователь-инициатор
     permlink <string>  // Целевой пост/комментарий

 award:
     // не реализованно в данной версии

 curatorReward:
     // не реализованно в данной версии

 message:
     // не реализованно в данной версии

 witnessVote:
     user <string>     // Пользователь, котрому предназначается эвент
     counter <number>  // Количество эвентов данного типа, склеенных воедино
     from <string>     // Пользователь-инициатор

 witnessCancelVote:
     user <string>     // Пользователь, котрому предназначается эвент
     counter <number>  // Количество эвентов данного типа, склеенных воедино
     from <string>     // Пользователь-инициатор
 ```

Возможные переменные окружения `ENV`:
  
  - `GLS_ONLINE_NOTIFY_CONNECT` *(обязательно)* - адрес подключения к микросервису онлайн нотификаций.

  - `GLS_PUSH_CONNECT` *(обязательно)* - адрес подключения к микросервису рассылки push-уведомлений.
    
  - `EVENT_EXPIRATION` - время в миллисекундах, после которого эвент будет удален из истории.  
   Дефолтное значение - `1000 * 60 * 60 * 24 * 30` (1 месяц) 
  
  - `GLS_GATE_HOST` *(обязательно)* - адрес, который будет использован для входящих подключений связи микросервисов.  
   Дефолтное значение при запуске без докера - `127.0.0.1`
  
  - `GLS_GATE_PORT` *(обязательно)* - адрес порта, который будет использован для входящих подключений связи микросервисов.  
   Дефолтное значение при запуске без докера - `8080`
  
  - `GLS_METRICS_HOST` *(обязательно)* - адрес хоста для метрик StatsD.  
   Дефолтное значение при запуске без докера - `127.0.0.1`
        
  - `GLS_METRICS_PORT` *(обязательно)* - адрес порта для метрик StatsD.  
   Дефолтное значение при запуске без докера - `8125`
  
  - `GLS_MONGO_CONNECT` - строка подключения к базе MongoDB.  
   Дефолтное значение - `mongodb://mongo/admin`
  
  - `GLS_DAY_START` - время начала нового дня в часах относительно UTC, используется для таких вещей как валидация "1 пост в сутки".    
   Дефолтное значение - `3` (день начинается в 00:00 по Москве). 
  
  - `GLS_BLOCKCHAIN_SUBSCRIBE_TIMEOUT` - таймаут подписки на новые блоки, срабатывает если за это время от блокчейн-ноды не пришло ни единого блока.  
   Дефолтное значение - `60000`, что равно одной минуте.
       
  - `GLS_BLOCKCHAIN_CONNECT` - адрес блокчейн-ноды для прослушивания.  
   Дефолтное значение - `wss://ws.golos.io`
 
Для запуска сервиса достаточно вызвать команду `docker-compose up` в корне проекта, предварительно указав
необходимые `ENV` переменные. 
